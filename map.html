<!DOCTYPE html>
<html>
<head>
  <style type="text/css">
    .tooltip {
      font-family: simsun;
      font-size: 16px;
      width: 200px;
      height: auto;
      position: absolute;
      text-align: center;
      border-style: solid;
      border-width: 1px;
      background-color: white;
      border-radius: 5px;
    }
    body {
      display: block;
      margin: 0px;
      overflow: hidden;
      padding: 0px;
    }
  </style>
  <style type="text/css">
    .tooltip2 {
      font-size: 13px;
      height: auto;
      width:auto; position: absolute;
      text-align: center;
    }
  </style>
  <style type="text/css">
    .selection{
      position: fixed;
      top: 20px;
      left: 180px;
    }
  </style>
  <script charset="utf-8" src="http://d3js.org/d3.v3.min.js"></script>
  <script src="https://d3js.org/d3-dsv.v1.min.js"></script>
  <script src="export.js" type="text/javascript"></script>
  <script src="math.js" type="text/javascript"></script>
  <script src="http://code.jquery.com/jquery.min.js" type="text/javascript"></script>
  <script src="http://underscorejs.org/underscore-min.js" type="text/javascript"></script>
  <title></title>
</head>
<body>
<div id="container">
  <div class = "selection">
    <select id="year_set" onchange="showSelectValue()">
      <option selected="selected" value="2007">2007
      </option>
      <option value="2008">2008
      </option>
      <option value="2009">2009
      </option>
      <option value="2010">2010
      </option>
      <option value="2011">2011
      </option>
      <option value="2012">2012
      </option>
      <option value="2013">2013
      </option>
      <option value="2014">2014
      </option>
      <option value="2015">2015
      </option>
      <option value="2016">2016
      </option>
    </select>


    <select id="product_set" onchange="showSelectValue()">
      <option selected="selected" value="Total">Total
      </option>
      <option value="01-05_Animal">Animal
      </option>
      <option value="06-15_Vegetable">Vegetable
      </option>
      <option value="16-24_FoodProd">FoodProd
      </option>
      <option value="25-26_Minerals">Minerals
      </option>
      <option value="27-27_Fuels">Fuels
      </option>
      <option value="28-38_Chemicals">Chemicals
      </option>
      <option value="39-40_PlastiRub">PlastiRub
      </option>
      <option value="41-43_HidesSkin">HidesSkin
      </option>
      <option value="44-49_Wood">Wood
      </option>
      <option value="50-63_TextCloth">TextCloth
      </option>
    </select>
  </div>

</div>

<svg>
  <radialgradient id="tip">
    <stop offset="0" stop-color="white"></stop>
    <stop offset="0.2" stop-color="pink"></stop>
    <stop offset="1" stop-color="white"></stop>
  </radialgradient>
</svg>
<script type="text/javascript">
    var marginTop = 30;
    var marginBottom = 30;
    var marginRight = 150;
    var marginLeft = 100;
    var height_stream = 380 - marginTop - marginBottom;
    var width_stream = 650 - marginLeft - marginRight;
    var height = 1000;
    var width = 1170;

    //creating svg to draw map
    //with id 'svg'
    var svg = d3.select('#container')
        .append('svg');
    var width2 = 500;
    var height2 = 500;
    svg.attr("width", width2)
        .attr("id", "svg1")
        .attr("height", height2)
        .style('position', 'absolute')
        .style('top', '40')
        .style('left', '0');
    var year_sel = d3.select('#year_div');
    var width_year = 200;
    var height_year = 100;
    //Obtain 'year' and 'element' from the selection list
    var obj = document.getElementById('year_set');
    var objProduct = document.getElementById('product_set');
    var obj_year2 = document.getElementById('year_select2');
    //clear all the things
    d3.selectAll("g").remove();
    //read the map data to draw map
    d3.json("world-countries.json", function(data) {
        var group = svg.selectAll("g").data(data.features).enter().append("g")
        var projection = d3.geo.mercator();
        var oldScala = projection.scale();
        var oldTranslate = projection.translate();
        xy = projection.scale(oldScala * (width / oldTranslate[0] / 2) * 2.0).translate([width / 2 - 500, height / 2 + 300]); //CENTER
        path = d3.geo.path().projection(xy);
        svg.attr('width', width).attr('height', height);
        //Define the domain of color channel
        var a = d3.rgb(255, 255, 255); //white
        var b = d3.rgb(255, 0, 0); //red
        //apply the domain of color channel
        var computeColor = d3.interpolate(a, b);
        //read the data to be the color information of the map
        d3.csv("all_country_export/" + objProduct.value + "_" + obj.value + ".csv", function(data) {
            var ex = data;
            //initial the tooltiop of the map
            var tooltip = d3.select("body")
                .append("div")
                .attr("class", "tooltip")
                .style("opacity", 0.0);
            //initial the tooltiop of the pie chart
            var tooltip2 = d3.select("body").append("div").attr("class", "tooltip2").attr("opacity", 0.0);
            //format the data from the csv
            var values = [];
            var valueArray = [];
            var norms = [];
            var normArray = [];
            for (var i = 0; i < ex.length; i++) {
                if (ex[i].country !== "WLD") {
                    var country = ex[i].country;
                    var value = ex[i].value;
                    values[country] = value;
                    valueArray.push(value * 1000 / 1000);
                }
            }
            var maxvalue = d3.max(valueArray);
            var minvalue = d3.min(valueArray);
            //console.log(maxvalue);
            //console.log(minvalue);

            //Data extractions and normalizations
            for (var j = 0; j < ex.length; j++) {
                if (ex[j].country !== "WLD") {
                    var ncountry = ex[j].country;
                    var nvalue = ex[j].value;
                    norms[ncountry] = (nvalue * 1000 - minvalue * 1000) / (maxvalue * 1000);
                    normArray.push((nvalue * 1000 - minvalue * 1000) / (maxvalue * 1000));
                }
            }
            console.log(normArray);
            // Define a linear scale mapping from the data domain to the color channel domain
            var min = d3.min(normArray);
            var max = d3.max(normArray);
            var linear = d3.scale.linear()
                .domain([min, max])
                .range([0, 1]);
            //--------
// Draw bar chart
            //Extract the top 5 value
            var max5=[];
            var max5array=[];
            var keyarray=[];
            for(var i=5;i>0;i--){
                var maxc=d3.entries(valueArray)
                    .sort(function(a,b){
                        return d3.descending(a.value, b.value);
                    });
                var c=[];
                c["key"]=Object.keys(values)[maxc[0].key];
                keyarray.push(Object.keys(values)[maxc[0].key]);
                c["value"]=maxc[0].value;
                max5.push(c);
                max5array.push(maxc[0].value);
                console.log(max5);
                valueArray[maxc[0].key]=0;
            }
            console.log(max5);
            var width=420;
            var height=400;
            var svg4=d3.select("#container").append("svg").attr("width",500).attr("height",400).attr("id","svg4").style("position","absolute").style("top","230").style("left","600");
            //Define clear area near the drawing area
            var padding = {left:120, right:30, top:40, bottom:20};
            //Define x,and y scales
            var xScale=d3.scale.ordinal().domain(d3.extent(keyarray,function(d){
                return keyarray;
            }))
                .rangeRoundBands([0, width -40 - padding.right]);
            var yScale = d3.scale.linear()
                .domain([0,d3.max(max5array)])
                .range([height - padding.top - padding.bottom, 0]);
            //Define x-axis
            var xAxis = d3.svg.axis()
                .scale(xScale)
                .orient("bottom");
            //Define y-axis
            var yAxis = d3.svg.axis()
                .ticks(8)
                .tickFormat(function(d){
                    return (d / 1000000).toFixed(2) + "M"
                })
                .scale(yScale)
                .orient("left");
            //Define intervals between bars
            var rectPadding = 40;
            //Add bars
            var rects = svg4.selectAll(".MyRect")
                .data(max5)
                .enter()
                .append("rect")
                .attr("class","MyRect")
                .attr("transform","translate(" + padding.left + "," + padding.top + ")")
                .attr("x", function(d,i){
                    return 50*i + rectPadding/2;
                } )
                .attr("y",function(d,i){
                    return yScale(max5[i]["value"]);
                })
                .attr("width", 40 )
                .attr("height", function(d,i){
                    return height - padding.top - padding.bottom - yScale(max5[i].value);
                })
                .attr("fill","red")
              //Add x-axis
            svg4.append("g")
                .attr("class","axis")
                .attr("transform","translate(" + padding.left + "," + (height - padding.bottom) + ")")
                .call(xAxis);
            svg4.append("text").attr("x", "30").attr("y", "20").style("font-size", "20px").text(function() {
                console.log(svg4.text);
                return "Top 5 Countries with the Largest Export Amount (USD $)";
            });
            //Add y-axis
            svg4.append("g")
                .attr("class","axis")
                .attr("transform","translate(" + padding.left + "," + padding.top + ")")
                .call(yAxis);
            //Add text
            var text=svg4.selectAll("text")
                .data(max5)
                .enter()
                .append("text")
                //.attr("class","MyText")
                .attr("transform","translate(" + padding.left + "," + padding.top + ")")
                .attr("x", function(d,i){
                    return xScale(i) + rectPadding/2;
                } )
                .attr("y",function(d){
                    return yScale(d);
                })
                .attr("dx",function(){
                    return (xScale.rangeBand() - rectPadding)/2;
                })
                .attr("dy",function(d){
                    return 20;
                })
                .text(function(d){
                    return d;
                });
            //--------
            //console.log(exportData.length);
            //Draw maps
            var areas = group.append("path")
                .attr("id", "mapShape")
                .attr("d", path)
                .attr("class", "area")
                .attr("fill", function(d) {
                    var t = linear(norms[d.id]);
                    var color = computeColor(t);
                    if (color == "#NaNNaNNaN") {
                        return "#efefef";
                    }
                    return color.toString();
                })
                //Define mouse event for map
                .on('mouseout', function(data) {
                    d3.select(this).attr('fill', function(d) {
                        tooltip.style("opacity", 0.0);
                        var t = linear(norms[d.id]);
                        var color = computeColor(t);
                        //console.log(color);
                        if (color == "#NaNNaNNaN") {
                            return "#efefef";
                        }
                        return color.toString();
                    });
                })
                .on('mouseover', function(data) {
                    //Set tooltips for high accuracy data exhibition
                    tooltip.html(data.properties.name + ": " + objProduct.value +"$" + (values[data.id] / 1000000).toFixed(2) + "M")
                        .style("left", (d3.event.pageX) + "px")
                        .style("top", (d3.event.pageY + 20) + "px")
                        .style("opacity", 1.0);
                    d3.select(this)
                        .attr('fill', 'rgba(2,2,139,0.61)');
                })
                .on('click', function(data) {
                    //Disable the Non-EU contries
                    d3.select("#container").select("#pro_select").remove();
                    d3.select("#container").select("#map_rect").remove();
                    d3.select("#container").select("#map_min_text").remove();
                    d3.select("#container").select("#map_max_text").remove();
                    d3.select("#container").select("#radient_rect").remove();
                    if (values[data.id] != undefined) {
                        var name ;
                        d3.select(this)
                            .attr('fill', function(d){
                                name = d.id;
                                return 'rgba(2,2,139,0.61)';
                            });
                        areas.attr("id", "mapShape")
                            .attr("d", path)
                            .attr("class", "area")
                            .attr("fill",function (data) {
                                if (data.id != name){
                                    return "#efefef"
                                }
                                else return 'rgba(2,2,139,0.61)';
                            }) //function(d){return color( )})
                            .on('mouseout', function(data) {
                                tooltip.style("opacity", 0.0);
                                d3.select(this).attr('fill', function(d) {
                                    if (d.id == name)
                                        return 'rgba(2,2,139,0.61)';
                                    else return "#efefef";
                                });
                            })
                            .on('mouseover', function(data) {
                                //Set tooltips for high accuracy data exhibition
                                tooltip.html(data.properties.name+ ":" + objProduct.value +" $" + (values[data.id] / 1000000).toFixed(2) + "M" )
                                    .style("left", (d3.event.pageX) + "px")
                                    .style("top", (d3.event.pageY + 20) + "px")
                                    .style("opacity", 1.0);
                            });

                        //Extract year attributes
                        var year = document.getElementById('year_set');
                        //console.log(year.value);
                        d3.csv("all_product_export/" + data.id + "_all_product_ex.csv", function(productdata) {
                            //clear pie chart and stacked area chart
                            d3.select('#container').select("#svg2").remove();
                            d3.select('#container').select("#stream").remove();
                            d3.select('#container').select("#svg4").remove();
                            //Creating svg2 to draw pie chart
                            var svg2 = d3.select('#container')
                                .append('svg');
                            var width2 = 720;
                            var height2 = 400;
                            svg2.attr("width", width2)
                                .attr("height", height2)
                                .attr("id", "svg2")
                                .style('position', 'absolute')
                                .style('left', '400');
                            //creating svg3 to draw stacked area chart
                            var svgSelection = d3.select('#container')
                                .append("svg");
                            svgSelection.attr("id", "stream")
                                .attr("width", width_stream + marginLeft + marginRight)
                                .attr("height", height_stream + marginTop + marginBottom)
                                .style('position', 'absolute')
                                .style('top', 360)
                                .style('left', 400);
                            for (var i = 0; i < ex.length; i++) {
                                if (year.value == productdata[i].year) {
                                    var showdata = [];
                                    showdata.push(productdata[i]['01-05_Animal']);
                                    showdata.push(productdata[i]['06-15_Vegetable']);
                                    showdata.push(productdata[i]['16-24_FoodProd']);
                                    showdata.push(productdata[i]['25-26_Minerals']);
                                    showdata.push(productdata[i]['27-27_Fuels']);
                                    showdata.push(productdata[i]['28-38_Chemicals']);
                                    showdata.push(productdata[i]['39-40_PlastiRub']);
                                    showdata.push(productdata[i]['41-43_HidesSkin']);
                                    showdata.push(productdata[i]['44-49_Wood']);
                                    showdata.push(productdata[i]['50-63_TextCloth']);
                                    var showsum = d3.sum(showdata);
                                    console.log(showsum);
                                    var showdataname = ['Animal', 'Vegetable', 'FoodProd', 'Minerals', 'Fuels', 'Chemicals', 'PlastiRub', 'HidesSkin', 'Wood', 'TextCloth'];
                                    break;
                                }
                            }
                            //------------
                            //Draw stream graphs
                            //Calculate the area for stacks
                            var parseDate = d3.time.format("%Y").parse;
                            productdata.forEach(function(d) {
                                d.year = parseDate(d.year);
                            });
                            var newDataset = ["01-05_Animal", "06-15_Vegetable", "16-24_FoodProd", "25-26_Minerals", "27-27_Fuels", "28-38_Chemicals", "39-40_PlastiRub", "41-43_HidesSkin", "44-49_Wood", "50-63_TextCloth"].map(function(n) {
                                return productdata.map(function(d, i) {
                                    return {
                                        x: d.year,
                                        y: Number(d[n]),
                                        y0: 0
                                    };
                                });
                            });
                            console.log(newDataset);
                            var baseGroup = svgSelection.append("g")
                                .attr("transform", "translate(" + marginLeft + "," + marginTop + ")");
                            var max_data = [];
                            //format the data
                            for (var k = 0; k < newDataset[1].length; k++) {
                                var d = 0;
                                for (var i = 0; i < 10; i++) {
                                    d = d + newDataset[i][k].y;
                                }
                                max_data.push(d)
                            }
                            console.log("max_data:" + max_data)
                            var maxHeight = d3.max(max_data);
                            console.log("max:" + maxHeight)
                            var minHeight = d3.min(newDataset, function(d) {
                                return d3.min(d, function(d) {
                                    return (d.y0);
                                }); //d.y +
                            });
                            //20 colors
                            var color = d3.scale.category20();
                            var xScale = d3.time.scale().range([0, width_stream]);
                            xScale.domain(d3.extent(productdata, function(d) {
                                return d.year
                            }))
                            var colorScale = d3.scale.ordinal().range(["#F37B6D", "#6CC071"]); //"#F37B6D", "#6CC071",
                            var hoverLabel = d3.scale.ordinal().range(["01-05_Animal", "06-15_Vegetable", "16-24_FoodProd", "25-26_Minerals", "27-27_Fuels", "28-38_Chemicals", "39-40_PlastiRub", "41-43_HidesSkin", "44-49_Wood", "50-63_TextCloth"]);
                            var yScale = d3.scale.linear().domain([1, 0]).range([0, height_stream]);//maxHeight
                            var yAxis = d3.svg.axis().scale(yScale)
                                .ticks(8, ",f")
                                .tickFormat(d3.format("%"))
                                .orient("left");
                            var xBar = d3.svg.axis().scale(xScale).orient("bottom");
                            var yScale2 = d3.scale.linear().domain([maxHeight, 0]).range([0, height_stream]);//maxHeight
                            //console.log(d3.max(all_areaData));
                            var yAxis2 = d3.svg.axis().scale(yScale2)
                                .ticks(8)
                                .tickFormat(function(d){
                                    return (d / 1000000).toFixed(2) + "M"
                                })
                                .orient("right");
                            baseGroup.append("g").attr("class", "yaxis2").attr("transform", "translate("+width_stream+",0  )") .call(yAxis2);
                            d3.layout.stack()(newDataset);
                            baseGroup.append("g").attr("class", "xaxis").attr("transform", "translate(0," + height_stream + ")") //height_stream
                                .call(xBar);
                            baseGroup.append("g").attr("class", "yaxis").call(yAxis);
                            var area = d3.svg.area().x(function(d) {
                                return xScale(d.x);
                            }).y0(function(d) {
                                return yScale(d.y0/maxHeight);
                            }).y1(function(d) {
                                return yScale((d.y + d.y0)/maxHeight);
                            });
                            var proGroup = baseGroup.selectAll(".valgroup")
                                .data(newDataset)
                                .enter()
                                .append("g")
                                .attr("class", "valgroup")
                                .style("fill", function(d, i) {
                                    //console.log("the color sequence number:"+ ((i+1)*2-1));
                                    return color(i);
                                }) //colorScale(i); })
                                .attr("class", function(d, i) {
                                    return hoverLabel(i);
                                });
                            console.log(data);
                            //set title
                            proGroup.append("text").attr("x", "45").attr("y", "0").style("font-size", "15px")
                                .style('fill',"black")
                                .text("Stream Graph of "+data.properties.name+" through All years (USD $)");
                            proGroup.append("path").attr("d", function(d) {
                                return area(d);
                            })
                                .on('mouseover', function(data,i) {
                                    //set tooltips for goods categories
                                    tooltip.html(showdataname[i])
                                        .style("left", (d3.event.pageX) + "px")
                                        .style("top", (d3.event.pageY + 20) + "px")
                                        .style("opacity", 1.0);
                                })
                                .on('mouseout', function(data) {
                                    tooltip.style("opacity", 0.0);
                                })
                                //Click on one of the stack and a corresponding line chart appear
                                .on('click', function(data) {
                                    d3.select("#container").select("#pro_select").remove();
                                    var proSelection = d3.select('#container')
                                        .append("svg");
                                    proSelection.attr("id", "pro_select")
                                        .attr("width", width_stream + marginLeft + marginRight)
                                        .attr("height", height_stream + marginTop + marginBottom)
                                        .style('position', 'absolute')
                                        .style('top', 360)
                                        .style('left', 1050);
                                    var baseGroup = proSelection.append("g")
                                        .attr("transform", "translate(" + marginLeft + "," + marginTop + ")");
                                    var all_areaData = [];
                                    var d = 0;
                                    for (var k = 0; k < data.length; k++) {
                                        console.log("data[k]:"+data[k]);
                                        d = data[k].y;
                                        all_areaData.push(d)
                                    }
                                    //console.log("max_data:" + all_areaData);
                                    var maxHeight = d3.max(max_data);
                                    var yScale2 = d3.scale.linear().domain([d3.max(all_areaData), 0]).range([0, height_stream]);//maxHeight
                                    //console.log(d3.max(all_areaData));
                                    var yAxis2 = d3.svg.axis().scale(yScale2)
                                        .ticks(8)
                                        .tickFormat(function(d){
                                            return (d / 1000000).toFixed(2) + "M"
                                        })
                                        .orient("left");
                                    baseGroup.append("g").attr("class", "xaxis").attr("transform", "translate(0," + height_stream + ")") //height_stream
                                        .call(xBar);
                                    baseGroup.append("g").attr("class", "yaxis2").call(yAxis2);
                                    var Line = d3.svg.line()
                                        .x(function(d) {
                                            //console.log(d.x);
                                            return xScale(d.x);
                                        })
                                        .y(function(d) {
                                            //console.log(d.y);
                                            return yScale2(d.y);
                                        })
                                        // set line types
                                        .interpolate('linear'); // append path and calculate the value with function line
                                    console.log(data);
                                    baseGroup.append('path')
                                        .attr('class', 'Line')
                                        .attr('d', Line(data))
                                        .attr('fill', 'none')
                                        .attr('stroke-width', 3)
                                        .attr('stroke', 'green');
                                    //title
                                    baseGroup.append('text').attr("x", "45").attr("y", "0").style("font-size", "15px")
                                        .style('fill',"black")
                                        .text("Line Graph of "+ showdataname[0]+" through All years (USD $)");
                                    var padding = {top: 20, right: 20, bottom:20, left:50};
                                    // draw dots
                                    baseGroup.selectAll("circle")
                                        .data(data)
                                        .enter().append("circle")
                                        .attr("class", "dot")
                                        .attr("r", function(d){
                                            //console.log(d.x.getFullYear(),year.value);
                                            if (d.x.getFullYear() == year.value){
                                                return 7;
                                            }
                                            return 5;
                                        })
                                        .attr("cx", function(d){return xScale(d.x);})
                                        .attr("cy", function(d){return yScale2(d.y);})
                                        .style("fill", function(d){
                                            //console.log(d.x.getFullYear(),year.value);
                                            if (d.x.getFullYear() == year.value){
                                                return 'red';
                                            }
                                            return 'green';
                                        })
                                        //set mouse event
                                        .on("mouseover", function(d) {
                                            tooltip_area.transition()
                                                .duration(200)
                                                .style("opacity", .9);
                                            tooltip_area.html((d.x.getFullYear())
                                                + ": " + (d.y / 1000000).toFixed(2) + "M" )
                                                .style("left", (d3.event.pageX + 5) + "px")
                                                .style("top", (d3.event.pageY - 28) + "px");
                                        })
                                        .on("mouseout", function(d) {
                                            tooltip_area.transition()
                                                .duration(500)
                                                .style("opacity", 0);
                                        });
                                });
                            //draw pie chart
                            var pie = d3.layout.pie();
                            var piedata = pie(showdata);
                            piedata[0].data = "Animal";
                            piedata[1].data = "Vegetable";
                            piedata[2].data = "FoodProd";
                            piedata[3].data = "Minerals";
                            piedata[4].data = "Fuels"
                            piedata[5].data = "Chemicals";
                            piedata[6].data = "PlastiRub";
                            piedata[7].data = "HidesSkin";
                            piedata[8].data = "Wood";
                            piedata[9].data = "TextCloth";
                            console.log(piedata);
                            var outerRadius = 110; //define outer radius
                            var innerRadius = 0; //inner radius
                            var arc = d3.svg.arc() //arc generator
                                .innerRadius(innerRadius) //apply inner radius
                                .outerRadius(outerRadius); //apply outer radius
                            //titles for pie chart
                            svg2.append("text").attr("x", "105").attr("y", "20").style("font-size", "15px")
                                .text("Export Values of All Categories in "+data.properties.name+" "+year.value + "(USD $)");
                            //===
                            var shape = svg2.append("rect").attr("x", "520").attr("y", "20").attr("rx", "10").attr("ry", "10").attr("width", "150").attr("height", "320").attr('stroke', 'red').attr('stroke-width', '5px').attr("fill", "white");
                            var hint = svg2.selectAll("rect").data(piedata);
                            hint.enter().append("rect").attr("x", "540").attr("y", function(d, i) {
                                return  30 * i;
                            }).attr("width", "50").attr("height", "25").attr("fill", function(d, i) {
                                return color(i);
                            });
                            svg2.append("rect").attr("x", "540").attr("y", function(d, i) {
                                return  30 *10;
                            }).attr("width", "50").attr("height", "25").attr("fill", function(d, i) {
                                return color(0);
                            });
                            var hinttext = svg2.selectAll("text").data(piedata);
                            hinttext.enter().append("text").attr("x", "600").attr("y", function(d, i) {
                                return 25 + 30 * i;
                            }).style("font-size", "12px").text(function(d, i) {
                                return d.data;
                            });
                            svg2.append("text").attr("x", "600").attr("y", function(d, i) {
                                return 25 + 30 * 10;
                            }).style("font-size", "12px").text(function(d, i) {
                                return piedata[0].data;
                            });
                            var arcs = svg2.selectAll("g").data(piedata).enter().append("g").attr("transform", "translate(" + 225 + "," + 180 + ")");
                            //.attr("transform","translate("+ (width2/2) +","+ (width2/2) +")");
                            //console.log("yes");
                            arcs.append("path").attr("fill", function(d, i) {
                                var num = 2 * i + 1;
                                console.log(num);
                                return color(i);
                            }).attr("d", function(d) {
                                return arc(d); //get path value
                            })
                            //====
                                .on('mouseover', function(data, d) {
                                    tooltip2.html(data.data + ":" + ((data.value * 1000) / (showsum * 1000) * 100).toFixed(2) + "%")
                                        .style("left", (d3.event.pageX) + "px")
                                        .style("top", (d3.event.pageY + 20) + "px")
                                        .style("opacity", 1.0);
                                    d3.select(this).attr('stroke', '#00ffff').attr('stroke-width', '3px');
                                }).on('mouseout', function(data) {
                                tooltip2.style("opacity", 0.0);
                                d3.select(this).transition().duration(200).attr('stroke', 'none');
                            })
                                .on("click",function(data,i){
                                    d3.select("#container").select("#pro_select").remove();
                                    var proSelection = d3.select('#container')
                                        .append("svg");
                                    proSelection.attr("id", "pro_select")
                                        .attr("width", width_stream + marginLeft + marginRight)
                                        .attr("height", height_stream + marginTop + marginBottom)
                                        .style('position', 'absolute')
                                        .style('top', 360)
                                        .style('left', 1050);
                                    var baseGroup = proSelection.append("g")
                                        .attr("transform", "translate(" + marginLeft + "," + marginTop + ")");
                                    var all_areaData = [];
                                    var d = 0;
                                    for (var k = 0; k < newDataset[i].length; k++) {
                                        //console.log("data[k]:"+data[k]);
                                        d = newDataset[i][k].y;
                                        all_areaData.push(d)
                                    }
                                    //console.log("max_data:" + all_areaData);
                                    var maxHeight = d3.max(max_data);
                                    var yScale2 = d3.scale.linear().domain([d3.max(all_areaData), 0]).range([0, height_stream]);//maxHeight
                                    //console.log(d3.max(all_areaData));
                                    var yAxis2 = d3.svg.axis().scale(yScale2)
                                        .ticks(8)
                                        .tickFormat(function(d){
                                            return (d / 1000000).toFixed(2) + "M"
                                        })
                                        .orient("left");
                                    baseGroup.append("g").attr("class", "xaxis").attr("transform", "translate(0," + height_stream + ")") //height_stream
                                        .call(xBar);
                                    baseGroup.append("g").attr("class", "yaxis2").call(yAxis2);
                                    var Line = d3.svg.line()
                                        .x(function(d) {
                                            //console.log(d.x);
                                            return xScale(d.x);
                                        })
                                        .y(function(d) {
                                            //console.log(d.y);
                                            return yScale2(d.y);
                                        })
                                        // 选择线条的类型
                                        .interpolate('linear'); // append path and calculate the value with function line
                                    //console.log(data);
                                    baseGroup.append('path')
                                        .attr('class', 'Line')
                                        .attr('d', Line(newDataset[i]))
                                        .attr('fill', 'none')
                                        .attr('stroke-width', 3)
                                        .attr('stroke', 'green');
                                    baseGroup.append('text').attr("x", "45").attr("y", "0").style("font-size", "15px")
                                        .style('fill',"black")
                                        .text("Line Graph of "+ showdataname[0]+" through All years (USD $)");
                                    var padding = {top: 20, right: 20, bottom:20, left:50};
                                    // draw dots
                                    baseGroup.selectAll("circle")
                                        .data(newDataset[i])
                                        .enter().append("circle")
                                        .attr("class", "dot")
                                        .attr("r", function(d){
                                            //console.log(d.x.getFullYear(),year.value);
                                            if (d.x.getFullYear() == year.value){
                                                return 7;
                                            }
                                            return 5;
                                        })
                                        .attr("cx", function(d){return xScale(d.x);})
                                        .attr("cy", function(d){return yScale2(d.y);})
                                        .style("fill", function(d){
                                            //console.log(d.x.getFullYear(),year.value);
                                            if (d.x.getFullYear() == year.value){
                                                return 'red';
                                            }
                                            return 'green';
                                        })
                                        .on("mouseover", function(d) {
                                            tooltip_area.transition()
                                                .duration(200)
                                                .style("opacity", .9);
                                            tooltip_area.html((d.x.getFullYear())
                                                + ": " + (d.y / 1000000).toFixed(2) + "M" )
                                                .style("left", (d3.event.pageX + 5) + "px")
                                                .style("top", (d3.event.pageY - 28) + "px");
                                        })
                                        .on("mouseout", function(d) {
                                            tooltip_area.transition()
                                                .duration(500)
                                                .style("opacity", 0);
                                        });
                                });
                        })
                    }
                }).attr('stroke', '#0A0A0A');
            //Define the color scale for Choropleth Chart
            var defs = svg.append("defs").attr("id",'defs');
            d3.select("#container").select("#radient_rect").remove();
            var linearGradient = defs.append("linearGradient").attr("id", "linearColor").attr("x1", "0%").attr("y1", "0%").attr("x2", "100%").attr("y2", "0%");
            var stop1 = linearGradient.append("stop").attr("offset", "0%").style("stop-color", a.toString());
            var stop2 = linearGradient.append("stop").attr("offset", "100%").style("stop-color", b.toString());
            //add rect for the color scale
            d3.select("#container").select("#map_rect").remove();
            svg.append("rect").attr("id","map_rect").attr("x", 5).attr("y", 660).attr("width", 245).attr("height", 70).style("fill", "white").attr('stroke', '#000000').attr('stroke-width', '2px').attr('rx','5').attr('ry','5');
            var colorRect = svg.append("rect").attr("id","radient_rect").attr("x", 20).attr("y", 680).attr("width", 210).attr("height", 20).style("fill", "url(#" + linearGradient.attr("id") + ")");
            //add text
            svg.selectAll("text").remove();
            var minValueText = svg.append("text").attr("id","map_min_text").attr("class", "valueText").attr("x", 10).attr("y", 720).attr("dy", "-0.3em").text(function() {
                return (minvalue/ 1000000).toFixed(2) + "M";
            });
            var maxValueText = svg.append("text").attr("id","map_max_text").attr("class", "valueText").attr("x", 140).attr("y", 720).attr("dy", "-0.3em").text(function() {
                return (maxvalue/ 1000000).toFixed(2) + "M";
            });
        })
    });
    //Call selected functions
    function showPieChart() {
        var obj = document.getElementById('year_select2');
        console.log(obj.value);
    }
    function showSelectValue() {
        var obj = document.getElementById('year_set');
        var objProduct = document.getElementById('product_set');
        d3.select('#container').select("#svg2").remove();
        d3.select('#container').select("#stream").remove();
        d3.select('#container').select("#svg4").remove();
        d3.select("#container").select("#pro_select").remove();

        d3.json("world-countries.json", function(data) {
            var group = svg.selectAll("g").data(data.features);
            //.enter()
            var projection = d3.geo.mercator();
            var oldScala = projection.scale();
            var oldTranslate = projection.translate();
            xy = projection.scale(oldScala * (width / oldTranslate[0] / 2) * 2.0).translate([width / 2 - 500, height / 2 + 300]); //CENTER
            path = d3.geo.path().projection(xy);
            svg.attr('width', width).attr('height', height);
            var a = d3.rgb(255, 255, 255); //white
            var b = d3.rgb(255, 0, 0); //

            var computeColor = d3.interpolate(a, b);
            d3.csv("all_country_export/" + objProduct.value + "_" + obj.value + ".csv", function(data) {
                var ex = data;
                var tooltip = d3.select("body")
                    .append("div")
                    .attr("class", "tooltip")
                    .style("opacity", 0.0);
                //====
                var tooltip2 = d3.select("body").append("div").attr("class", "tooltip2").attr("opacity", 0.0);
                //====
                var values = [];
                var valueArray = [];
                var norms = [];
                var normArray = [];
                for (var i = 0; i < ex.length; i++) {
                    if (ex[i].country !== "WLD") {
                        var country = ex[i].country;
                        var value = ex[i].value;
                        values[country] = value;
                        valueArray.push(value * 1000 / 1000);
                    }
                }
                //console.log(valueArray);
                var maxvalue = d3.max(valueArray);
                var minvalue = d3.min(valueArray);
                console.log(maxvalue);
                console.log(minvalue);

                for (var j = 0; j < ex.length; j++) {
                    if (ex[j].country !== "WLD") {
                        var ncountry = ex[j].country;
                        var nvalue = ex[j].value;
                        norms[ncountry] = (nvalue * 1000 - minvalue * 1000) / (maxvalue * 1000);
                        normArray.push((nvalue * 1000 - minvalue * 1000) / (maxvalue * 1000));1
                    }
                }
                //--------
                //---
                //console.log(norms);
                //console.log(normArray);
                var min = d3.min(normArray);
                var max = d3.max(normArray);
                var linear = d3.scale.linear().domain([min, max]).range([0, 1]);
                //console.log(exportData.length);
                //console.log(valueArray);
                //console.log(values);
                //console.log("attr", values[Object.keys(values)[21]]);
                //console.log("attr", Object.getOwnPropertyNames(values)[16]);
                ///---------
                //--------
                var max5=[];
                var max5array=[];
                var keyarray=[];
                for(var i=5;i>0;i--){
                    var maxc=d3.entries(valueArray)
                        .sort(function(a,b){
                            return d3.descending(a.value, b.value);
                        });
                    console.log(maxc[0]);
                    var c=[];
                    c["key"]=Object.keys(values)[maxc[0].key];
                    keyarray.push(Object.keys(values)[maxc[0].key]);
                    c["value"]=maxc[0].value;
                    max5.push(c);
                    max5array.push(maxc[0].value);
                    console.log(max5);
                    valueArray[maxc[0].key]=0;
                }
                console.log(max5);
                var width=420;
                var height=400;
                var svg4=d3.select("#container").append("svg").attr("width",500).attr("height",400).attr("id","svg4").style("position","absolute").style("top","230").style("left","600");

                var padding = {left:120, right:30, top:40, bottom:20};
                var xScale=d3.scale.ordinal().domain(d3.extent(keyarray,function(d){
                    return keyarray;
                }))
                    .rangeRoundBands([0, width -40 - padding.right]);
                /* var xScale=d3.scale.ordinal().domain(d3.range(max5array.length))
                     .rangeRoundBands([0, width - padding.left - padding.right]);*/
                var yScale = d3.scale.linear()
                    .domain([0,d3.max(max5array)])
                    .range([height - padding.top - padding.bottom, 0]);

                var xAxis = d3.svg.axis()
                    .scale(xScale)
                    .orient("bottom");

                var yAxis = d3.svg.axis()
                    .ticks(8)
                    .tickFormat(function(d){
                        return (d / 1000000).toFixed(2) + "M"
                    })
                    .scale(yScale)
                    .orient("left");

                var rectPadding = 40;

                var rects = svg4.selectAll(".MyRect")
                    .data(max5)
                    .enter()
                    .append("rect")
                    .attr("class","MyRect")
                    .attr("transform","translate(" + padding.left + "," + padding.top + ")")
                    .attr("x", function(d,i){
                        return 50*i + rectPadding/2;
                    } )
                    .attr("y",function(d,i){
                        return yScale(max5[i]["value"]);
                    })
                    .attr("width", 40 )
                    .attr("height", function(d,i){
                        return height - padding.top - padding.bottom - yScale(max5[i].value);
                    })
                    .attr("fill","red")

                svg4.append("g")
                    .attr("class","axis")
                    .attr("transform","translate(" + padding.left + "," + (height - padding.bottom) + ")")
                    .call(xAxis);
                svg4.append("text").attr("x", "50").attr("y", "20").style("font-size", "20px").text(function() {
                    console.log(svg4.text);
                    return "Top 5 Countries with the Largest Export Amount (USD $)";
                });

                svg4.append("g")
                    .attr("class","axis")
                    .attr("transform","translate(" + padding.left + "," + padding.top + ")")
                    .call(yAxis);

                var text=svg4.selectAll("text")
                    .data(max5)
                    .enter()
                    .append("text")
                    //.attr("class","MyText")
                    .attr("transform","translate(" + padding.left + "," + padding.top + ")")
                    .attr("x", function(d,i){
                        return xScale(i) + rectPadding/2;
                    } )
                    .attr("y",function(d){
                        return yScale(d);
                    })
                    .attr("dx",function(){
                        return (xScale.rangeBand() - rectPadding)/2;
                    })
                    .attr("dy",function(d){
                        return 20;
                    })
                    .text(function(d){
                        return d;
                    });
                var areas = group.selectAll("path")
                    .transition()
                    .duration(200)
                    .attr("fill", function(d) {
                        var t = linear(norms[d.id]);
                        var color = computeColor(t);
                        //console.log(color);
                        if (color == "#NaNNaNNaN") {
                            return "#efefef";
                        }
                        return color.toString();
                    })
                group.selectAll("path").on('mouseout', function (data) {
                    d3.select(this).attr('fill', function (data){
                        tooltip.style("opacity",0.0);
                        var t = linear(norms[data.id]);
                        var color = computeColor(t);
                        //console.log(color.toString());
                        //console.log(color);
                        if (color == "#NaNNaNNaN") {
                            return "#efefef";
                        }
                        return color.toString();
                    });
                })
                    .on('mouseover', function (data) {
                        d3.select(this).attr('fill', 'rgba(2,2,139,0.61)');
                    });

                var defs = svg.append("defs").attr("id",'defs');
                d3.select("#container").select("#radient_rect").remove();
                var linearGradient = defs.append("linearGradient").attr("id", "linearColor").attr("x1", "0%").attr("y1", "0%").attr("x2", "100%").attr("y2", "0%");
                var stop1 = linearGradient.append("stop").attr("offset", "0%").style("stop-color", a.toString());
                var stop2 = linearGradient.append("stop").attr("offset", "100%").style("stop-color", b.toString());

                d3.select("#container").select("#map_rect").remove();
                svg.append("rect").attr("id","map_rect").attr("x", 5).attr("y", 660).attr("width", 245).attr("height", 70).style("fill", "white").attr('stroke', '#000000').attr('stroke-width', '2px').attr('rx','5').attr('ry','5');
                var colorRect = svg.append("rect").attr("id","radient_rect").attr("x", 20).attr("y", 680).attr("width", 210).attr("height", 20).style("fill", "url(#" + linearGradient.attr("id") + ")");

                svg.selectAll("text").remove();
                var minValueText = svg.append("text").attr("id","map_min_text").attr("class", "valueText").attr("x", 10).attr("y", 720).attr("dy", "-0.3em").text(function() {
                    return (minvalue/ 1000000).toFixed(2) + "M";
                });
                var maxValueText = svg.append("text").attr("id","map_max_text").attr("class", "valueText").attr("x", 140).attr("y", 720).attr("dy", "-0.3em").text(function() {
                    return (maxvalue/ 1000000).toFixed(2) + "M";
                });
            });
        });

    }


</script>
</body>
</html>